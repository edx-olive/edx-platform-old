## coding=utf-8

## This is the main Mako template that all page templates should include.
## Note: there are a handful of pages that use Django Templates and which
## instead include main_django.html. It is important that these two files
## remain in sync, so changes made in one should be applied to the other.

## Pages currently use v1 styling by default. Once the Pattern Library
## rollout has been completed, this default can be switched to v2.
<%! main_css = "style-main-v1" %>


<%namespace name='static' file='static_content.html'/>
<% online_help_token = self.online_help_token() if hasattr(self, 'online_help_token') else None %>
<%!
from branding import api as branding_api
from django.core.urlresolvers import reverse
from django.utils.http import urlquote_plus
from django.utils.translation import ugettext as _
from django.utils.translation import get_language_bidi
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
from pipeline_mako import render_require_js_path_overrides

%>
<!DOCTYPE html>
<!--[if lte IE 9]><html class="ie ie9 lte9" lang="${LANGUAGE_CODE}"><![endif]-->
<!--[if !IE]><!--><html lang="${LANGUAGE_CODE}"><!--<![endif]-->
<head dir="${static.dir_rtl()}">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

## Define a couple of helper functions to make life easier when
## embedding theme conditionals into templates. All inheriting
## templates have access to these functions, and we can import these
## into non-inheriting templates via the %namespace tag.

## this needs to be here to prevent the title from mysteriously appearing in the body, in one case
<%def name="pagetitle()" />
  <%block name="title">
      <title>
       ${static.get_page_title_breadcrumbs(self.pagetitle())}
      </title>
  </%block>

  % if not allow_iframing:
      <script type="text/javascript">
        /* immediately break out of an iframe if coming from the marketing website */
        (function(window) {
          if (window.location !== window.top.location) {
            window.top.location = window.location;
          }
        })(this);
      </script>
  % endif

  <%
    jsi18n_path = "js/i18n/{language}/djangojs.js".format(language=LANGUAGE_CODE)
  %>

  <script type="text/javascript" src="${static.url(jsi18n_path)}"></script>

  <link rel="icon" type="image/x-icon" href="${static.url(static.get_value('favicon_path', settings.FAVICON_PATH))}" />

  <%static:css group='style-vendor'/>
  % if uses_bootstrap:
    <link rel="stylesheet" href="${static.url(self.attr.main_css)}" type="text/css" media="all" />
  % else:
    <%static:css group='${self.attr.main_css}'/>
  % endif

  % if disable_courseware_js or uses_pattern_library:
    <%static:js group='base_vendor'/>
    <%static:js group='base_application'/>
  % else:
    <%static:js group='main_vendor'/>
    <%static:js group='application'/>
  % endif

  % if uses_bootstrap:
    <%static:js group='lms_bootstrap'/>
  % endif

  <script>
    window.baseUrl = "${settings.STATIC_URL | n, js_escaped_string}";
    (function (require) {
      require.config({
          baseUrl: window.baseUrl
      });
    }).call(this, require || RequireJS.require);
  </script>
  <script type="text/javascript" src="${static.url("lms/js/require-config.js")}"></script>
  <%block name="js_overrides">
    ${render_require_js_path_overrides(settings.REQUIRE_JS_PATH_OVERRIDES) | n, decode.utf8}
  </%block>

  % if not disable_courseware_js:
    <%static:js group='module-js'/>
  % endif

  <%block name="headextra"/>
  <%block name="head_extra"/>

  <%include file="/courseware/experiments.html"/>
  <%static:optional_include_mako file="head-extra.html" is_theming_enabled="True" />

  <%include file="widgets/optimizely.html" />
  <%include file="widgets/segment-io.html" />

  <meta name="path_prefix" content="${EDX_ROOT_URL}">
  <meta name="google-site-verification" content="_mipQ4AtZQDNmbtOkwehQDOgCxUUV2fb_C0b6wbiRHY" />

<% ga_acct = static.get_value("GOOGLE_ANALYTICS_ACCOUNT", settings.GOOGLE_ANALYTICS_ACCOUNT) %>
% if ga_acct:
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '${ga_acct | n, js_escaped_string}']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
% endif

</head>

<body class="${static.dir_rtl()} <%block name='bodyclass'/> lang_${LANGUAGE_CODE}">


<!-- Start temporary notification: after update to KOA no need in this code -->
<div id="freeze-notification" class="wrapper wrapper-alert wrapper-alert-announcement" style="position: absolute;">
  <span class="feedback-symbol fa fa-bullhorn" aria-hidden="true"></span>
  <div style="margin: 0 auto;max-width: 725px;">
    <div>
      <div class="copy" style="direction: rtl;text-align: right;">
        <h2 class="title title-3 title-text" style="font-weight: bold;margin: 0;line-height: 24px;"></h2>
        <p class="body-text" style="margin: 0;"></p>
      </div>
      <ul style="list-style: none;">
        <li class="action-dismiss">
          <div onclick="toggleNotification(null, 'freeze-notification', false)" style="border-width: 1px;border-style: solid;background: transparent;line-height: 17px;text-align: center;border-color: rgba(255,255,255,0.5);color: rgba(255,255,255,0.75);padding: 7px 16px;display: inline-block;border-radius: 4px;cursor: pointer;">
            <span class="icon fa fa-times-circle" aria-hidden="true"></span>
            <span class="button-copy">Hide</span>
          </div>
        </li>
      </ul>
    </div>
  </div>
</div>

  <script type="text/javascript">

    const _jsonConfigFileUrl = "https://api.npoint.io/adc875fa4dad77e1effe";
    const _showFreezeNotification = "_showFreezeNotification";
    const _ttl = 86400000; // show this notification once per 24 hour
    const _today = new Date();
    const _notificationDefault =
    { 
      id: 0,
      startDateStr: "03-01-2022 00:00:00 UTC+02:00",
      stopDateStr: "04-01-2030 23:59:59 UTC+03:00",
      text: {
        title: "לא הצלחנו לטעון את תוכן ההודעה.",
        body: [
          "ניתן לפנות לתמיכה במייל: <a href='mailto:support.koa@campus.gov.il'>support.koa@campus.gov.il</a>",
        ]
      }
    };
    var _notifications = [];
      
    // ttl in milliseconds
    function setWithExpiry(key, value, ttl) {
      const now = new Date()

      // `item` is an object which contains the original value
      // as well as the time when it's supposed to expire
      const item = {
        value: value,
        expiry: now.getTime() + ttl,
      }
      localStorage.setItem(key, JSON.stringify(item))
    }

    function getWithExpiry(key) {
      const itemStr = localStorage.getItem(key)
      // if the item doesn't exist, return null
      if (!itemStr) {
        return null
      }
      const item = JSON.parse(itemStr)
      const now = new Date()
      // compare the expiry time of the item with the current time
      if (now.getTime() > item.expiry) {
        // If the item is expired, delete the item from storage
        // and return null
        localStorage.removeItem(key)
        return undefined
      }
      return item.value
    }

    function toggleNotification($el, id, isShow) {
      // prepare element in case element is not provided
      if (!$el) $el = $('#' + id);
      
      // toggle in case status is not provided
      if (isShow == null || isShow == undefined)
        isShow = !$el.hasClass('is-shown');

      // toggle the notification
      if (isShow)
        $el.addClass('is-shown');
      else {
        $el.removeClass('is-shown');

        // in case user don't want to see the message again --> set flag for message dissapear
        setWithExpiry(_showFreezeNotification, 1, _ttl); // add to localstorage
      }
    }

    function showFreezeNotification(ttl, text) {
      let _isExist = getWithExpiry(_showFreezeNotification);
      if (_isExist == null) {
        let _freezeNotif = $('#freeze-notification');
        let _title = $('#freeze-notification .title-text');
        let _body = $('#freeze-notification .body-text');

        // set title text
        _title.html('<div>' + text.title + '</div><br/>');

        // set body text(s)
        text.body.forEach(bodyRow => {
          if (!bodyRow) _body.append('<br/>');
          else _body.append('<div>' + bodyRow + '</div>');
        });

        toggleNotification(_freezeNotif, true);         // hide show notification

        return true;
      }
    };

    function isShowFreezeNotification() {
      _notifications.forEach(element => {

        // create date objects
        element.startDate = new Date(element.startDateStr);
        element.stopDate = new Date(element.stopDateStr);

        // check the date objects
        if (element.startDate <= _today && element.stopDate > _today) {
          return !showFreezeNotification(_ttl, element.text);    
        }
      });
    }

    fetch(_jsonConfigFileUrl)
      .then(response => {
        return response.json();
      })
      .then(jsondata => {
        // set notifications data
        _notifications = jsondata.notifications;

        // show notification
        isShowFreezeNotification();
      }).catch(function(error) {
        // set the default notification message
        _notifications.push(_notificationDefault);

        // show notification
        isShowFreezeNotification();

        // add error to logs
        console.log(error);
      });

  </script>
  <!-- Stop temporary notification -->
  
<%static:optional_include_mako file="body-initial.html" is_theming_enabled="True" />
<div id="page-prompt"></div>
% if not disable_window_wrap:
  <div class="window-wrap" dir="${static.dir_rtl()}">
% endif
    <a class="nav-skip sr-only sr-only-focusable" href="#main">${_("Skip to main content")}</a>

    % if not disable_header:
        <%include file="${static.get_template_path('header.html')}" args="online_help_token=online_help_token" />
        <%include file="/preview_menu.html" />
    % endif

    <div class="content-wrapper ${"container-fluid" if uses_bootstrap else "" } main-container" id="content" dir="${static.dir_rtl()}">
      ${self.body()}
      <%block name="bodyextra"/>
    </div>

    % if not disable_footer:
        <%include file="${static.get_template_path('footer.html')}" />
    % endif

% if not disable_window_wrap:
  </div>
% endif

  <%block name="footer_extra"/>
  <%block name="js_extra"/>

  <%include file="widgets/segment-io-footer.html" />
  <script type="text/javascript" src="${static.url('js/vendor/noreferrer.js')}" charset="utf-8"></script>
  <script type="text/javascript" src="${static.url('js/utils/navigation.js')}" charset="utf-8"></script>
  <%static:optional_include_mako file="body-extra.html" is_theming_enabled="True" />
</body>
</html>

<%def name="login_query()">${
  u"?next={0}".format(urlquote_plus(login_redirect_url)) if login_redirect_url else ""
}</%def>

<!-- Performance beacon for onload times -->
% if settings.FEATURES.get('ENABLE_ONLOAD_BEACON', False):
<script>
  (function () {
    var sample_rate = ${settings.ONLOAD_BEACON_SAMPLE_RATE | n, dump_js_escaped_json};
    var roll = Math.floor(Math.random() * 100)/100;
    var onloadBeaconSent = false;

    if(roll < sample_rate){
      $(window).load(function() {
        setTimeout(function(){
          var t = window.performance.timing;

          var data = {
            event: "onload",
            value: t.loadEventEnd - t.navigationStart,
            page: window.location.href,
          };

          if (!onloadBeaconSent) {
            $.ajax({method: "POST", url: "/performance", data: data});
          }
          onloadBeaconSent = true;
        }, 0);
      });
    }
  }());
</script>
% endif
